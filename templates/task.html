<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <title>Task Details | Projo 1</title>
    <style>
        .progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-bar {
            height: 1.5rem;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-pending { background-color: #fbbf24; color: #92400e; }
        .status-queued { background-color: #60a5fa; color: #1e40af; }
        .status-processing { background-color: #8b5cf6; color: #5b21b6; }
        .status-completed { background-color: #10b981; color: #065f46; }
        .status-failed { background-color: #ef4444; color: #7f1d1d; }
        
        .hidden { display: none; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .processing-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>
<div class="relative isolate overflow-hidden bg-gray-900 py-24 sm:py-32">
  <div class="mx-auto max-w-7xl px-6 lg:px-8">
    
    <!-- Task Header -->
    <div class="mx-auto max-w-2xl lg:mx-0">
      <h2 class="text-5xl font-semibold tracking-tight text-white" id="filename">{{task.original_filename}}</h2>
      <p class="mt-8 text-lg font-medium text-pretty text-gray-300 sm:text-xl/8">
        Task ID: <span id="task-id" class="font-mono">{{task.id}}</span>
      </p>
    </div>
    
    <!-- Progress Dashboard -->
    <div class="mt-8 bg-gray-800 rounded-xl p-6 shadow-lg">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Status -->
        <div>
          <p class="text-gray-400 text-sm mb-2">Status</p>
          <div id="status-badge" class="status-badge status-{{task.status}}">
            {{task.status|title}}
          </div>
        </div>
        
        <!-- Progress Bar -->
        <div>
          <p class="text-gray-400 text-sm mb-2">Progress</p>
          <div class="flex items-center">
            <div class="w-full mr-4">
              <div class="progress-container">
                <div id="progress-bar" class="progress-bar" style=`width:{{task.progress or 0}}%;`>
                  {{task.progress or 0}}%
                </div>
              </div>
            </div>
            <span id="progress-text" class="text-white font-medium">
              {{task.progress or 0}}%
            </span>
          </div>
        </div>
        
        <!-- Actions -->
        <div>
          <p class="text-gray-400 text-sm mb-2">Actions</p>
          <div id="action-buttons">
            {% if task.status == "completed" %}
            <a href="/tasks/{{ task.id }}/download"
               class="inline-flex items-center bg-green-600 text-white font-medium rounded-lg text-sm px-4 py-2.5 hover:bg-green-700 transition">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Download Result
            </a>
            {% endif %}
          </div>
        </div>
      </div>
      
      <!-- Status Details -->
      <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        <div class="text-gray-300">
          <span class="text-gray-400">Uploaded:</span>
          <span id="upload-time">
            {% if task.created_at %}
              {% set ist_time = task.created_at.fromtimestamp(task.created_at.timestamp() + 19800) %}
              {{ist_time.strftime('%d-%m-%Y %H:%M:%S')}} IST
            {% endif %}
          </span>
        </div>
        
        <div class="text-gray-300">
          <span class="text-gray-400">Started:</span>
          <span id="started-time">
            {% if task.started_at %}
              {% set ist_time = task.started_at.fromtimestamp(task.started_at.timestamp() + 19800) %}
              {{ist_time.strftime('%H:%M:%S')}}
            {% else %}
              Not started
            {% endif %}
          </span>
        </div>
        
        <div class="text-gray-300">
          <span class="text-gray-400">Completed:</span>
          <span id="completed-time">
            {% if task.completed_at %}
              {% set ist_time = task.completed_at.fromtimestamp(task.completed_at.timestamp() + 19800) %}
              {{ist_time.strftime('%H:%M:%S')}}
            {% else %}
              Not completed
            {% endif %}
          </span>
        </div>
      </div>
      
      <!-- Status Messages -->
      <div class="mt-4">
        <div id="status-message" class="text-gray-300 text-sm">
          {% if task.status == "pending" %}
            <p>‚úÖ File uploaded successfully. Please configure processing options below.</p>
          {% elif task.status == "queued" %}
            <p>‚è≥ Task is queued and waiting for a worker. It will start processing soon...</p>
          {% elif task.status == "processing" %}
            <p>üîÑ Task is being processed. Please wait...</p>
          {% elif task.status == "completed" %}
            <p>‚úÖ Task completed successfully! You can download the result.</p>
          {% elif task.status == "failed" %}
            <p class="text-red-400">‚ùå Task failed: {{ task.error_message|truncate(100) if task.error_message else 'Unknown error' }}</p>
          {% endif %}
        </div>
        
        <!-- Real-time Operation Updates -->
        <div id="real-time-updates" class="mt-4 hidden">
          <div class="flex items-center text-sm text-blue-400">
            <svg id="progress-spinner" class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span id="current-operation">Initializing...</span>
          </div>
          <div class="ml-6 mt-2 text-xs text-gray-400" id="operation-details"></div>
        </div>
      </div>
    </div>
    
    <!-- Preview Section -->
    <h3 class="mt-8 text-xl text-white font-medium">Preview:</h3>
    <div class="overflow-x-auto border rounded-lg mt-4
                [&_table]:w-full [&_table]:text-sm [&_table]:text-center 
                [&_th]:bg-gray-50 [&_th]:p-3 [&_th]:mx-3 [&_th]:border-b [&_th]:text-center [&_th]:font-semibold [&_td]:text-white
                [&_td]:py-3 [&_td]:border-b">
        {{ preview_html | safe }}
    </div>
    
    <!-- Configuration Form (Only show for pending tasks) -->
    <div id="config-form" class="task-config-form mx-auto max-w-7xl px-6 lg:px-8 text-white mt-8 
        {% if task.status != 'pending' %}hidden{% endif %}">
        <form class="p-8">
            <div>
                <fieldset>
                    <legend class="text-2xl font-semibold">Choose your tasks:</legend>
                    <div class="my-4 flex flex-col gap-y-4">
                    <div>
                        <input type="checkbox" id="drop_columns" name="interest" value="drop_columns" class="w-4 h-4 border border-default-medium rounded-xs bg-neutral-secondary-medium focus:ring-2 focus:ring-brand-soft">
                        <label for="drop_columns">Drop Columns</label>
                        <div class="hidden-div hidden mx-4 px-4">
                            <label for="dropcolumn_columns">Mention the columns (with comma):</label>
                            <input class="border ml-4 p-2 rounded-lg " type="text" id="dropcolumn_columns" name="dropcolumn_columns"><br>
                        </div>
                    </div>
                    <div>
                        <input type="checkbox" id="remove_duplicates" name="interest" value="remove_duplicates" class="w-4 h-4 border border-default-medium rounded-xs bg-neutral-secondary-medium focus:ring-2 focus:ring-brand-soft">
                        <label for="remove_duplicates">Remove Duplicates</label>
                        <div class="hidden-div hidden mx-4 px-4">
                            <label for="rmduplicates_columns">Mention the columns (with comma):</label>
                            <input class="border ml-4 p-2 rounded-lg " type="text" id="rmduplicates_columns" name="rmduplicates_columns"><br>
                        </div>
                    </div>
                    <div>
                    <input type="checkbox" id="remove_missing_rows" name="interest" value="remove_missing_rows" class="w-4 h-4 border border-default-medium rounded-xs bg-neutral-secondary-medium focus:ring-2 focus:ring-brand-soft">
                    <label for="remove_missing_rows">Remove rows with missing values</label>
                    <div class="hidden-div hidden mx-4 px-4">
                        <label for="rmmissingrows_columns">Mention the columns (with comma):</label>
                        <input class="border ml-4 p-2 rounded-lg " type="text" id="rmmissingrows_columns" name="rmmissingrows_columns"><br>
                    </div>
                    </div>
                    <div>
                    <input type="checkbox" id="fill_missing" name="interest" value="fill_missing" class="w-4 h-4 border border-default-medium rounded-xs bg-neutral-secondary-medium focus:ring-2 focus:ring-brand-soft">
                    <label for="fill_missing">Fill missing values</label>
                    <div class="hidden-div hidden mx-4 px-4">
                        <label for="fill_missing_columns">Mention the column & the fill value:</label>
                        <input class="border ml-4 p-2 rounded-lg " type="text" id="fill_missing_columns" name="fill_missing_columns"><br>
                        <span class="text-gray-500 text-sm">Format: column1:value1,column2:value2</span>
                    </div>
                    </div>
                </div>
                </fieldset>
            </div>
            <button id="submit-btn" class="text-white bg-purple-500 font-medium rounded-base text-sm px-4 py-2.5 text-center leading-5 mx-auto mt-4 hover:bg-purple-600 transition" type="submit">Process</button>
        </form>
    </div>
    
    <!-- Error Details -->
    {% if task.status == "failed" and task.error_message %}
    <div id="error-details" class="mt-8 bg-red-900/30 border border-red-700 rounded-lg p-4">
      <h4 class="text-red-300 font-medium mb-2">Error Details:</h4>
      <pre class="text-red-200 text-sm whitespace-pre-wrap overflow-auto max-h-48">{{ task.error_message }}</pre>
    </div>
    {% endif %}
    
  </div>
</div>

<script>
// ========== GLOBAL VARIABLES ==========
let pollingInterval = null;
let taskId = document.getElementById('task-id').innerText;
let currentStatus = '{{task.status}}';

// ========== PROGRESS POLLING FUNCTIONS ==========
function startProgressPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    
    pollingInterval = setInterval(fetchTaskProgress, 1500);
    
    fetchTaskProgress();
}

function stopProgressPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

async function fetchTaskProgress() {
    try {
        const response = await fetch(`/tasks/${taskId}/progress`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        updateTaskUI(data);
        
        if (data.status === 'completed' || data.status === 'failed') {
            stopProgressPolling();
            
            if (data.status === 'completed') {
                setTimeout(() => {
                    updateActionButtons(data);
                }, 1000);
            }
        }
    } catch (error) {
        console.error('Error fetching progress:', error);
    }
}

function updateTaskUI(data) {
    const statusBadge = document.getElementById('status-badge');
    statusBadge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
    statusBadge.className = `status-badge status-${data.status}`;
    
    // Update progress bar
    const progress = data.progress || 0;
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${progress}%`;
    
    document.getElementById('progress-text').textContent = `${progress}%`;
    
    updateTimestamps(data);
    updateStatusMessages(data);
    updateOperationDetails(data);
    
    if (data.status === 'processing') {
        statusBadge.classList.add('processing-pulse');
        document.getElementById('real-time-updates').classList.remove('hidden');
    } else {
        statusBadge.classList.remove('processing-pulse');
        document.getElementById('real-time-updates').classList.add('hidden');
    }
    
    if (data.status !== 'pending') {
        document.getElementById('config-form').classList.add('hidden');
    }
}

function updateTimestamps(data) {
    if (data.started_at) {
        const startedTime = new Date(data.started_at);
        const istStartedTime = new Date(startedTime.getTime() + (5.5 * 60 * 60 * 1000));
        document.getElementById('started-time').textContent = 
            istStartedTime.toLocaleTimeString('en-IN', {hour12: false});
    }
    
    if (data.completed_at) {
        const completedTime = new Date(data.completed_at);
        const istCompletedTime = new Date(completedTime.getTime() + (5.5 * 60 * 60 * 1000));
        document.getElementById('completed-time').textContent = 
            istCompletedTime.toLocaleTimeString('en-IN', {hour12: false});
    }
}

function updateStatusMessages(data) {
    const statusMessage = document.getElementById('status-message');
    
    switch(data.status) {
        case 'pending':
            statusMessage.innerHTML = '<p>‚úÖ File uploaded successfully. Please configure processing options below.</p>';
            break;
        case 'queued':
            statusMessage.innerHTML = '<p>‚è≥ Task is queued and waiting for a worker. It will start processing soon...</p>';
            break;
        case 'processing':
            const op = data.current_operation || 'Processing';
            const step = data.current_step || '';
            const total = data.total_steps || '';
            let stepText = '';
            if (step && total) {
                stepText = ` (Step ${step} of ${total})`;
            }
            statusMessage.innerHTML = `<p>üîÑ Task is being processed${stepText}. Please wait...</p>`;
            break;
        case 'completed':
            statusMessage.innerHTML = '<p>‚úÖ Task completed successfully! You can download the result.</p>';
            break;
        case 'failed':
            const errorMsg = data.error_message ? data.error_message.substring(0, 200) + '...' : 'Unknown error';
            statusMessage.innerHTML = `<p class="text-red-400">‚ùå Task failed: ${errorMsg}</p>`;
            break;
    }
}

function updateOperationDetails(data) {
    const currentOpElement = document.getElementById('current-operation');
    const opDetailsElement = document.getElementById('operation-details');
    
    if (data.celery_status) {
        currentOpElement.textContent = data.celery_status;
    }
    
    if (data.current_operation) {
        let details = `Operation: ${data.current_operation}`;
        if (data.current_step && data.total_steps) {
            details += ` | Step ${data.current_step} of ${data.total_steps}`;
        }
        if (data.celery_progress && data.celery_total) {
            details += ` | Progress: ${data.celery_progress}/${data.celery_total}`;
        }
        opDetailsElement.textContent = details;
    }
}

function updateActionButtons(data) {
    const actionButtons = document.getElementById('action-buttons');
    
    if (data.status === 'completed' && data.result_path) {
        actionButtons.innerHTML = `
            <a href="/tasks/${taskId}/download"
               class="inline-flex items-center bg-green-600 text-white font-medium rounded-lg text-sm px-4 py-2.5 hover:bg-green-700 transition">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Download Result
            </a>
        `;
    }
}

// ========== CONFIGURATION FORM HANDLING ==========
document.addEventListener('change', function(event) {
    if (event.target.name === 'interest') {
        const checkbox = event.target;
        const hiddenDiv = checkbox.parentElement.querySelector('.hidden-div') || 
                        checkbox.closest('div').querySelector('.hidden');
        if (hiddenDiv) {
            hiddenDiv.classList.toggle('hidden', !checkbox.checked);
        }
    }
});

const form = document.querySelector('form');
if (form) {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-btn');
        const originalText = submitBtn.textContent;
        const originalBg = submitBtn.className;
        
        // Show loading state
        submitBtn.textContent = 'Queuing...';
        submitBtn.disabled = true;
        submitBtn.className = originalBg.replace('bg-purple-500', 'bg-purple-400');
        
        // Build task configuration
        const selectedInterests = form.querySelectorAll('input[name="interest"]:checked');
        const taskConfig = Array.from(selectedInterests).map(checkbox => {
            const value = checkbox.value;
            const parentContainer = checkbox.closest('div');
            const textInput = parentContainer.querySelector('input[type="text"]');
            const inputValue = textInput ? textInput.value.trim() : '';
            
            if (value === "drop_columns") {
                return {
                    op: value,
                    params: {"columns": inputValue.split(',').map(c => c.trim()).filter(c => c)}
                };
            } else if (value === "fill_missing") {
                const columns = inputValue.split(',').map(c => c.trim()).filter(c => c);
                const columnsMap = {};
                columns.forEach(col => {
                    const [colName, colValue] = col.split(':');
                    if (colName && colValue) {
                        columnsMap[colName.trim()] = colValue.trim();
                    }
                });
                return {
                    op: value,
                    params: {"method": "constant", "columns": columnsMap}
                };
            } else {
                return {
                    op: value,
                    params: {"subset": inputValue.split(',').map(c => c.trim()).filter(c => c)}
                };
            }
        });
        
        try {
            const response = await fetch(`/task/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "operations": taskConfig })
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('Task queued:', result);
                
                document.getElementById('config-form').classList.add('hidden');
                
                startProgressPolling();
                
                showNotification('Task configuration saved and queued for processing!', 'success');
            } else {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to queue task');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification(`Failed to save configuration: ${error.message}`, 'error');
            
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            submitBtn.className = originalBg;
        }
    });
}

// ========== HELPER FUNCTIONS ==========
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-600 text-white' : 
        type === 'error' ? 'bg-red-600 text-white' : 
        'bg-blue-600 text-white'
    }`;
    notification.textContent = message;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
    // If task is already queued or processing, start polling
    if (currentStatus === 'queued' || currentStatus === 'processing') {
        startProgressPolling();
    }
    
    // Auto-refresh page if task is completed (optional)
    //if (currentStatus === 'completed') {
    //    setTimeout(() => {
            // Refresh to show download button
    //        window.location.reload();
    //    }, 1000);
    //}
});
</script>
</body>
</html>